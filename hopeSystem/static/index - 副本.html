<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="x5-page-mode" content="no-title">
	<meta name="x5-orientation" content="portrait">
	<meta name="full-screen" content="yes">
	<meta name="screen-orientation" content="portrait">
    <title>优卡星积分奖励系统</title>
	<link type="image/x-icon" href="favicon.ico" rel="shortcut icon">
	<link rel="stylesheet" href="css/growthTree.css">
    <link rel="stylesheet" href="css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
		:root {
			--primary: #4e73df;
			--primary-light: #858796;
			--secondary: #1cc88a;
			--danger: #e74a3b;
			--warning: #f6c23e;
			--light: #f8f9fc;
			--dark: #5a5c69;
			--shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
			--tree-color: #57A773;
			--tree-trunk: #795648;
			--energy-color: #ffa800;
		}
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: #333;
            line-height: 1.6;
            padding-bottom: 80px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 100%;
            padding: 0 15px;
        }
        
        /* 头部样式 */
        header {
            background: linear-gradient(to right, var(--primary), #2a55c5);
            color: white;
            padding: 20px 15px;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            border-radius: 0 0 20px 20px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--primary);
            border: 3px solid rgba(255, 255, 255, 0.3);
        }
        
        .user-details {
            flex: 1;
        }
        
        .user-details h1 {
            font-size: 1.4rem;
            margin-bottom: 5px;
        }
        
        .user-details p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        /* 积分展示 */
		.points-display {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: var(--shadow);
            display: flex;
            position: relative;
            overflow: hidden;
        }
        
		.points-display::before {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			height: 5px;
			background: linear-gradient(to right, var(--secondary), var(--primary));
		}
        .points-left {
            flex: 1;
            padding-right: 20px;
            border-right: 1px solid #eee;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: center;
        }
        
        .points-right {
            flex: 1;
            padding-left: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .points-left h2 {
            font-size: 1.2rem;
            color: var(--dark);
            margin-bottom: 10px;
        }
        
        .points-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            margin: 10px 0;
        }
        
        .performance-rating {
            display: inline-block;
            padding: 5px 5px;
            border-radius: 20px;
            background: #e1f0ff;
            color: var(--primary);
            font-size: 0.9rem;
            font-weight: 500;
            margin-top: 10px;
        }
        
        /* 积分统计图 */
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: var(--shadow);
        }
        
        .chart-title {
            font-size: 1.1rem;
            color: var(--dark);
            margin-bottom: 15px;
            text-align: center;
        }
        
        .chart {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 200px;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            position: relative;
        }
        
        .chart-bar {
            width: 12%;
            background: linear-gradient(to top, var(--primary), #6f8df7);
            border-radius: 5px 5px 0 0;
            position: relative;
            transition: height 0.5s ease;
        }
        
        .chart-label {
            position: absolute;
            bottom: -25px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 0.8rem;
            color: var(--dark);
        }
        
        .chart-value {
            position: absolute;
            top: -25px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 0.85rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        /* 今日表现 */
        .today-performance {
            background: white;
            border-radius: 15px;
            padding: 2px 20px;
            margin: 20px 0;
            box-shadow: var(--shadow);
        }
        
        .today-summary {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .add-summary, .minus-summary {
            padding: 10px;
            border-radius: 10px;
            width: 45%;
        }
        
        .add-summary {
            background: #e1f7ed;
            color: var(--secondary);
        }
        
        .minus-summary {
            background: #fde8e7;
            color: var(--danger);
        }
        
        .summary-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .performance-time {
            text-align: center;
            font-size: 0.9rem;
            color: #777;
            margin-top: 10px;
        }
        
        /* 导航栏 */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: var(--shadow);
        }
        
        .nav-tab {
            flex: 1;
            text-align: center;
            padding: 15px 5px;
            font-weight: 500;
            color: var(--primary-light);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .nav-tab.active {
            color: var(--primary);
        }
        
        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 10%;
            right: 10%;
            height: 3px;
            background: var(--primary);
            border-radius: 3px;
        }
        
        .nav-tab i {
            display: block;
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        /* 内容区域 */
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-title {
            font-size: 1.3rem;
            color: var(--dark);
            margin: 20px 0 15px;
            padding-left: 10px;
            border-left: 4px solid var(--primary);
        }
        
        /* 卡片样式 */
        .card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1.5rem rgba(58, 59, 69, 0.2);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .card-title {
            font-weight: 600;
            color: var(--dark);
        }
        
        .points-badge {
            padding: 3px 10px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .add-points .points-badge {
            background: #e1f7ed;
            color: var(--secondary);
        }
        
        .minus-points .points-badge {
            background: #fde8e7;
            color: var(--danger);
        }
        
        .card-content {
            font-size: 0.95rem;
            color: #666;
        }
        
        .action-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: none;
            border-radius: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s ease;
            text-align: center;
        }

		.wram-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: none;
            border-radius: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s ease;
            text-align: center;
        }
        
        .add-btn {
            background: #e1f7ed;
            color: var(--secondary);
        }
        
        .add-btn:hover {
            background: #c4f1db;
        }
        
        .minus-btn {
            background: #fde8e7;
            color: var(--danger);
        }
        
        .minus-btn:hover {
            background: #fcd5d3;
        }
        
        /* 类别卡片 */
        .category-card {
            display: flex;
            align-items: center;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            background: white;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .category-card:hover {
            transform: translateX(5px);
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1);
        }
        
        .category-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-right: 15px;
        }
        
        .study-icon {
            background: #e1f0ff;
            color: var(--primary);
        }
        
        .life-icon {
            background: #fff2e0;
            color: #ff9f43;
        }
        
        .grade-icon {
            background: #e1f7ed;
            color: var(--secondary);
        }
        
        .character-icon {
            background: #f0e7ff;
            color: #9b59b6;
        }
        
        .other-icon {
            background: #e0f7f7;
            color: #16a085;
        }
        
        .category-details {
            flex: 1;
        }
        
        .category-name {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }
        
        .category-desc {
            font-size: 0.9rem;
            color: #777;
        }
        
        /* 兑换卡片 */
        .exchange-card {
            position: relative;
            overflow: hidden;
        }
        
        .exchange-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--warning);
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .exchange-points {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
            margin: 10px 0;
            text-align: center;
        }
        
        .exchange-btn {
            background: linear-gradient(to right, var(--primary), #2a55c5);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px;
            width: 100%;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }
        
        .exchange-btn:hover {
            opacity: 0.9;
        }
        
        /* 记录列表 */
        .record-tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
            box-shadow: var(--shadow);
        }
        
        .record-tab {
            flex: 1;
            text-align: center;
            padding: 12px 5px;
            font-weight: 500;
            color: var(--primary-light);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .record-tab.active {
            color: var(--primary);
            background: #eef4ff;
        }
        
        .record-content {
			min-height: 500px; /* 记录区域最小高度 */
            display: none;
        }
        
        .record-content.active {
            display: block;
        }
        
        .record-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .record-item:last-child {
            border-bottom: none;
        }
        
        .record-details {
            flex: 1;
        }
        
        .record-title {
            font-weight: 500;
            margin-bottom: 3px;
        }
        
        .record-date {
            font-size: 0.8rem;
            color: #888;
        }
        
        .record-points {
            font-weight: bold;
            min-width: 50px;
            text-align: right;
        }
        
        .add-points-record .record-points {
            color: var(--secondary);
        }
        
        .minus-points-record .record-points {
            color: var(--danger);
        }
        
        .exchange-record .record-points {
            color: var(--primary);
        }
        
        /* 表单样式 */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
			height:50px;
			background: #fff;
			font-color:#000;
        }
        
        .form-input:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        .back-btn {
            display: inline-block;
            padding: 8px 15px;
            background: #eef4ff;
            color: var(--primary);
            border-radius: 10px;
            margin-bottom: 15px;
            cursor: pointer;
        }
        
        /* 底部导航 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }
        
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.8rem;
            color: var(--primary-light);
            cursor: pointer;
            transition: color 0.3s ease;
            padding: 5px 10px;
            border-radius: 10px;
        }
        
        .nav-btn.active {
            color: var(--primary);
            background: #eef4ff;
        }
        
        .nav-btn i {
            font-size: 1.2rem;
            margin-bottom: 3px;
        }
        
        /* 响应式调整 */
        @media (min-width: 768px) {
            .container {
                max-width: 750px;
                margin: 0 auto;
            }
            
            .cards-container {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .card {
                margin-bottom: 0;
            }
            
            .exchange-container {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
        }

        .datetime-container {
            position: absolute;
            top: 15px;
            right: 15px;
            text-align: right;
            z-index: 1;
        }

        .current-date {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 8px;
            font-weight: 500;
        }

        .current-time {
            font-size: 1.4rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            animation: pulse 1.5s infinite;
        }

		/* 添加加载样式 */
		.loading-placeholder {
			text-align: center;
			padding: 20px;
			color: var(--primary-light);
		}

		.loading-placeholder i {
			margin-right: 10px;
		}

		.no-items {
			text-align: center;
			padding: 20px;
			color: var(--primary-light);
			font-style: italic;
		}

		/* 头像容器 */
		.avatar {
			width: 60px;
			height: 60px;
			border-radius: 50%;
			background: #fff;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 24px;
			color: var(--primary);
			border: 3px solid rgba(255, 255, 255, 0.3);
			overflow: hidden; /* 确保图片不溢出 */
		}

		/* 头像图片 */
		.avatar img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}

		/* 记录项背景样式修复 */
		.record-content .card {
			background: white;
			border-radius: 15px;
			padding: 0; /* 移除内部填充 */
			box-shadow: var(--shadow);
			overflow: hidden; /* 确保圆角生效 */
		}

		.record-item {
			display: flex;
			justify-content: space-between;
			padding: 12px 15px; /* 增加水平内边距 */
			border-bottom: 1px solid #eee;
			background: white; /* 确保每个记录项都有白色背景 */
			transition: background-color 0.3s ease;
		}

		.record-item:last-child {
			border-bottom: none;
		}

		.record-item:hover {
			background-color: #f8f9fc; /* 悬停效果 */
		}

		/* 无记录提示样式 */
		.no-items, .loading-placeholder {
			padding: 20px;
			text-align: center;
			color: var(--primary-light);
			background: white; /* 添加背景色 */
			border-radius: 15px; /* 圆角 */
			box-shadow: var(--shadow); /* 阴影 */
		}

		.error {
			padding: 20px;
			text-align: center;
			color: var(--danger);
			background: white;
			border-radius: 15px;
			box-shadow: var(--shadow);
		}


		/* 加载状态样式 */
		.loading-placeholder {
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			padding: 20px;
			background: white;
			border-radius: 15px;
			box-shadow: var(--shadow);
		}

		.loading-placeholder i {
			font-size: 24px;
			margin-bottom: 10px;
			color: var(--primary);
			animation: spin 1s linear infinite;
		}

		@keyframes spin {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}

		/* 分页样式 */
		.pagination-container {
			display: flex;
			justify-content: center;
			margin-top: 20px;
			padding: 10px;
			background: white;
			border-radius: 15px;
			box-shadow: var(--shadow);
		}

		.pagination-btn {
			padding: 8px 15px;
			margin: 0 5px;
			border: none;
			border-radius: 8px;
			background: #eef4ff;
			color: var(--primary);
			cursor: pointer;
			transition: all 0.3s ease;
		}

		.pagination-btn:hover {
			background: var(--primary);
			color: white;
		}

		.pagination-btn:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}

		.pagination-info {
			margin: 0 15px;
			display: flex;
			align-items: center;
			color: var(--dark);
		}

		/* 添加响应式调整 */
		@media (max-width: 480px) {
			#account-tip span {
				font-size: 0.8rem;
			}
			
			#qrcode-container {
				width: 150px;
				height: 150px;
			}
		}

		#scroll-anchor {
			position: absolute;
			top: 0;
			left: 0;
			width: 1px;
			height: 1px;
			visibility: hidden;
			pointer-events: none;
		}
		
		/* 管理页面样式 */
        .manage-tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: var(--shadow);
        }
        
        .manage-tab {
            flex: 1;
            text-align: center;
            padding: 12px 5px;
            font-weight: 500;
            color: var(--primary-light);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .manage-tab.active {
            color: var(--primary);
            background: #eef4ff;
        }
        
        .manage-content {
            display: none;
        }
        
        .manage-content.active {
            display: block;
        }
        
        .manage-item {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .manage-item-details {
            flex: 1;
        }
        
        .manage-item-name {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }
        
        .manage-item-points {
            font-size: 0.9rem;
            color: #777;
        }
        
        .manage-item-actions {
            display: flex;
            gap: 10px;
        }
        
        .edit-btn, .delete-btn {
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .edit-btn {
            background: #e1f0ff;
            color: var(--primary);
        }
        
        .edit-btn:hover {
            background: #c9dfff;
        }
        
        .delete-btn {
            background: #fde8e7;
            color: var(--danger);
        }
        
        .delete-btn:hover {
            background: #fcd5d3;
        }
        
        .add-item-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: none;
            border-radius: 10px;
            background: #e1f7ed;
            color: var(--secondary);
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .add-item-btn:hover {
            background: #c4f1db;
        }
        
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 0.5rem 1.5rem rgba(0,0,0,0.3);
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }
        
        .cancel-btn {
            background: #f8f9fc;
            color: var(--dark);
        }
        
        .save-btn {
            background: var(--primary);
            color: white;
        }
		
		 /* 烟花容器 */
        .fireworks-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }
        
        /* 数字显示 */
        .firework-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 20px #00c853, 
                         0 0 40px #64dd17, 
                         0 0 80px #a7ffeb;
            opacity: 0;
            z-index: 101;
            animation: numberPulse 1.2s ease-out;
        }
        
        @keyframes numberPulse {
            0% { 
                opacity: 0; 
                transform: translate(-50%, -50%) scale(0.1);
                filter: blur(20px);
            }
            20% { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1.1);
                filter: blur(0px);
            }
            70% { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1);
            }
            100% { 
                opacity: 0; 
                transform: translate(-50%, -50%) scale(0.8);
            }
        }
        
        /* 烟花粒子 */
        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
            animation: particleAnimation 1.2s ease-out forwards;
        }
        
        @keyframes particleAnimation {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }
        
        
		
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部区域 -->
        <header>
            <div class="user-info">
                <div class="avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-details">
                    <h1>豆豆</h1>
                    <p></p>
                    <div class="datetime-container">
                        <div id="current-date" class="current-date"></div>
                        <div id="current-time" class="current-time"></div>
                    </div>
                </div>
            </div>
			<!-- 添加开通账号提示 -->
			<div id="account-tip" style="display: none; background: rgb(70 75 174); border-radius: 8px; padding: 5px; margin-top: 5px; text-align: center;">
				<i class="fas fa-exclamation-circle" style="color: #ffc107;"></i>
				<span>您使用的是演示账号，扫码加群开通专属账号</span>
			</div>
        </header>
        
		 <!-- 积分展示区域 - 左右结构 -->
        <div class="points-display">
            <!-- 左侧：积分信息 -->
            <div class="points-left">
                <h2>当前积分</h2>
                <div class="points-value"></div>
                <div class="performance-rating" id="biaoxian">优秀表现</div>
            </div>
            
            <!-- 右侧：成长树 -->
            <div class="points-right">
                <div class="tree-container">

                    
                    <div class="tree">
						<div class="sun"></div>
                        <img class="tree-image" id="tree-image" src="1.png" alt="成长树">
                    </div>
                    
                    <!-- 能量条 - 带点状动画 -->
                    <div class="energy-bar-container">
                        <div class="energy-label">
                            <span id="tree-stage"></span>
                            <span id="energy-value"></span>
                        </div>
                        <div class="energy-bar">
                            <div class="energy-progress">
                                <div class="progress-steps" id="progress-fill">
                                    <div class="progress-step"></div>
                                    <div class="progress-step"></div>
                                    <div class="progress-step"></div>
                                </div>
                                <div class="dot-animation" id="dot-container"></div>
                            </div>
                        </div>
                        <div class="next-stage" id="next-stage"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 导航标签 -->
		<div id="scroll-anchor"></div>
        <div class="nav-tabs">
            <div class="nav-tab active" data-target="home">
                <i class="fas fa-home"></i>
                <span>首页</span>
            </div>
            <div class="nav-tab" data-target="add">
                <i class="fas fa-plus-circle"></i>
                <span>加分</span>
            </div>
            <div class="nav-tab" data-target="minus">
                <i class="fas fa-minus-circle"></i>
                <span>减分</span>
            </div>
            <div class="nav-tab" data-target="exchange">
                <i class="fas fa-gift"></i>
                <span>兑换</span>
            </div>
            <div class="nav-tab" data-target="records">
                <i class="fas fa-history"></i>
                <span>记录</span>
            </div>
	
        </div>
        
        <!-- 内容区域 -->
        <div id="home" class="content-section active">
            
            <!-- 今日表现 -->
            <div class="today-performance">
                <h2 class="section-title">今日表现</h2>
                
                <div class="today-summary">
                    <div class="add-summary">
                        <div>今日加分</div>
                        <div class="summary-value">+15</div>
                    </div>
                    <div class="minus-summary">
                        <div>今日减分</div>
                        <div class="summary-value">-2</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">完成作业情况</div>
                        <div class="points-badge">+8分</div>
                    </div>
                    <div class="card-content">
                        21:30前认真完成各科作业
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">生活习惯</div>
                        <div class="points-badge">+7分</div>
                    </div>
                    <div class="card-content">
                        主动洗漱、认真吃早餐、7点起床
                    </div>
                </div>
                
                <div class="performance-time">
                    最近记录时间: 今天 18:45
                </div>
            </div>
            <h2 class="section-title">积分兑换推荐</h2>
            <div class="cards-container jftj" id="jftj">
				<div class="loading-placeholder">
					<i class="fas fa-spinner fa-spin"></i> 加载推荐奖励中...
				</div>
			</div>
            <!-- 积分统计图 -->
            <div class="chart-container">
                <div class="chart-title">最近7天积分变化</div>
                <div class="chart">
                    <div class="chart-bar" style="height: 80px;">
                        <div class="chart-value">+15</div>
                        <div class="chart-label">周一</div>
                    </div>
                    <div class="chart-bar" style="height: 120px;">
                        <div class="chart-value">+22</div>
                        <div class="chart-label">周二</div>
                    </div>
                    <div class="chart-bar" style="height: 60px;">
                        <div class="chart-value">+8</div>
                        <div class="chart-label">周三</div>
                    </div>
                    <div class="chart-bar" style="height: 150px;">
                        <div class="chart-value">+28</div>
                        <div class="chart-label">周四</div>
                    </div>
                    <div class="chart-bar" style="height: 100px;">
                        <div class="chart-value">+18</div>
                        <div class="chart-label">周五</div>
                    </div>
                    <div class="chart-bar" style="height: 70px;">
                        <div class="chart-value">+12</div>
                        <div class="chart-label">周六</div>
                    </div>
                    <div class="chart-bar" style="height: 40px;">
                        <div class="chart-value">+5</div>
                        <div class="chart-label">周日</div>
                    </div>
                </div>
            </div>

			<!-- 添加开通账号区域 -->
			<div id="account-request" style="display: none;">
				<h2 class="section-title">开通专属账号</h2>
				<div class="card" style="text-align: center;">
					<p style="margin-bottom: 15px;">扫码加群联系管理员开通个人专属账号</p>
					<div id="qrcode-container" style="margin: 0 auto; width: 200px; height: 200px; background: #f8f9fc; display: flex; align-items: center; justify-content: center; border-radius: 10px;">
						<i class="fas fa-qrcode" style="font-size: 100px; color: #ddd;"></i>
					</div>
					<p style="margin-top: 15px; font-size: 0.9rem; color: #666;">群名: 优卡星(豆豆积分奖励系统）</p>
					<button id="hide-tip-btn" class="wram-btn" style="background: #eef4ff; color: var(--primary); margin-top: 15px;">
						我知道了，不再提示
					</button>
				</div>
			</div>
        </div>
        
        <!-- 加分页面 -->
        <div id="add" class="content-section">
            <h2 class="section-title">选择加分类型</h2>
            
            <div class="category-card" data-category="study">
                <div class="category-icon study-icon">
                    <i class="fas fa-book"></i>
                </div>
                <div class="category-details">
                    <div class="category-name">学习习惯</div>
                    <div class="category-desc">作业完成、复习预习、阅读等</div>
                </div>
                <i class="fas fa-chevron-right"></i>
            </div>
            
            <div class="category-card" data-category="life">
                <div class="category-icon life-icon">
                    <i class="fas fa-home"></i>
                </div>
                <div class="category-details">
                    <div class="category-name">生活习惯</div>
                    <div class="category-desc">洗漱、饮食、起床睡觉等</div>
                </div>
                <i class="fas fa-chevron-right"></i>
            </div>
            
            <div class="category-card" data-category="grade">
                <div class="category-icon grade-icon">
                    <i class="fas fa-medal"></i>
                </div>
                <div class="category-details">
                    <div class="category-name">学习成绩</div>
                    <div class="category-desc">考试、奖状、听写默写等</div>
                </div>
                <i class="fas fa-chevron-right"></i>
            </div>
            
            <div class="category-card" data-category="character">
                <div class="category-icon character-icon">
                    <i class="fas fa-heart"></i>
                </div>
                <div class="category-details">
                    <div class="category-name">性格养成</div>
                    <div class="category-desc">情绪管理、尊敬长辈等</div>
                </div>
                <i class="fas fa-chevron-right"></i>
            </div>
            
            <div class="category-card" data-category="other">
                <div class="category-icon other-icon">
                    <i class="fas fa-plus"></i>
                </div>
                <div class="category-details">
                    <div class="category-name">其他加分</div>
                    <div class="category-desc">自定义加分项</div>
                </div>
                <i class="fas fa-chevron-right"></i>
            </div>
        </div>
        
        <!-- 学习习惯加分页 -->
        <div id="add-study" class="content-section">
            <div class="back-btn" data-back="add">
                <i class="fas fa-arrow-left"></i> 返回加分类型
            </div>
            <h2 class="section-title">学习习惯加分</h2>
            
        </div>
		<div id="add-life" class="content-section">
            <div class="back-btn" data-back="add">
                <i class="fas fa-arrow-left"></i> 返回加分类型
            </div>
            <h2 class="section-title">生活习惯加分</h2>
       
        </div>
		<div id="add-grade" class="content-section">
            <div class="back-btn" data-back="add">
                <i class="fas fa-arrow-left"></i> 返回加分类型
            </div>
            <h2 class="section-title">学习成绩加分</h2>
        </div>
		<div id="add-character" class="content-section">
            <div class="back-btn" data-back="add">
                <i class="fas fa-arrow-left"></i> 返回加分类型
            </div>
            <h2 class="section-title">性格养成加分</h2>
        </div>
        
        <!-- 其他加分页 -->
        <div id="add-other" class="content-section">
            <div class="back-btn" data-back="add">
                <i class="fas fa-arrow-left"></i> 返回加分类型
            </div>
            <h2 class="section-title">其他加分项</h2>
            
            <div class="card">
                <div class="form-group">
                    <label class="form-label">加分说明</label>
                    <input type="text" class="form-input" placeholder="请输入加分原因">
                </div>
                
                <div class="form-group">
                    <label class="form-label">加分分值</label>
                    <input type="number" class="form-input" placeholder="请输入分值" min="1" max="50">
                </div>
                
                <button class="action-btn add-btn">确认加分</button>
            </div>
        </div>
        
        <!-- 减分页面 -->
        <div id="minus" class="content-section">
            <h2 class="section-title">选择减分类型</h2>
            
            <div class="category-card" data-category="study">
                <div class="category-icon study-icon">
                    <i class="fas fa-book"></i>
                </div>
                <div class="category-details">
                    <div class="category-name">学习习惯</div>
                    <div class="category-desc">作业完成、学习态度等</div>
                </div>
                <i class="fas fa-chevron-right"></i>
            </div>
            
            <div class="category-card" data-category="life">
                <div class="category-icon life-icon">
                    <i class="fas fa-home"></i>
                </div>
                <div class="category-details">
                    <div class="category-name">生活习惯</div>
                    <div class="category-desc">作息、饮食、卫生等</div>
                </div>
                <i class="fas fa-chevron-right"></i>
            </div>


			<div class="category-card" data-category="grade">
                <div class="category-icon grade-icon">
                    <i class="fas fa-medal"></i>
                </div>
                <div class="category-details">
                    <div class="category-name">学习成绩</div>
                    <div class="category-desc">考试、奖状、听写默写等</div>
                </div>
                <i class="fas fa-chevron-right"></i>
            </div>
            
            <div class="category-card" data-category="character">
                <div class="category-icon character-icon">
                    <i class="fas fa-heart"></i>
                </div>
                <div class="category-details">
                    <div class="category-name">性格养成</div>
                    <div class="category-desc">情绪管理、诚实守信等</div>
                </div>
                <i class="fas fa-chevron-right"></i>
            </div>
            
            <div class="category-card" data-category="other">
                <div class="category-icon other-icon">
                    <i class="fas fa-minus"></i>
                </div>
                <div class="category-details">
                    <div class="category-name">其他减分</div>
                    <div class="category-desc">自定义减分项</div>
                </div>
                <i class="fas fa-chevron-right"></i>
            </div>
        </div>
        
        <!-- 生活习惯减分页 -->
		<div id="minus-study" class="content-section">
            <div class="back-btn" data-back="minus">
                <i class="fas fa-arrow-left"></i> 返回减分类型
            </div>
            <h2 class="section-title">学习习惯减分</h2>
            
        </div>
		<div id="minus-life" class="content-section">
            <div class="back-btn" data-back="minus">
                <i class="fas fa-arrow-left"></i> 返回减分类型
            </div>
            <h2 class="section-title">生活习惯减分</h2>
       
        </div>
		<div id="minus-grade" class="content-section">
            <div class="back-btn" data-back="minus">
                <i class="fas fa-arrow-left"></i> 返回减分类型
            </div>
            <h2 class="section-title">学习成绩减分</h2>
        </div>
		<div id="minus-character" class="content-section">
            <div class="back-btn" data-back="minus">
                <i class="fas fa-arrow-left"></i> 返回减分类型
            </div>
            <h2 class="section-title">性格养成减分</h2>
        </div>
        
        
        
        <!-- 其他减分页 -->
        <div id="minus-other" class="content-section">
            <div class="back-btn" data-back="minus">
                <i class="fas fa-arrow-left"></i> 返回减分类型
            </div>
            <h2 class="section-title">其他减分项</h2>
            
            <div class="card">
                <div class="form-group">
                    <label class="form-label">减分说明</label>
                    <input type="text" class="form-input" placeholder="请输入减分原因">
                </div>
                
                <div class="form-group">
                    <label class="form-label">减分分值</label>
                    <input type="number" class="form-input" placeholder="请输入分值" min="1" max="50">
                </div>
                
                <button class="action-btn minus-btn">确认减分</button>
            </div>
        </div>
        
        <!-- 积分兑换 -->
        <div id="exchange" class="content-section">
            <h2 class="section-title">积分兑换</h2>
            
            <div class="exchange-container" id="jfdh">
				<div class="loading-placeholder">
					<i class="fas fa-spinner fa-spin"></i> 加载奖励项目中...
				</div>
			</div>
            
            <h2 class="section-title">其他兑换</h2>
             <!-- 添加ID标识自定义兑换区域 -->
            <div class="card" id="custom-exchange-card">
                <div class="form-group">
                    <label class="form-label">兑换说明</label>
                    <!-- 添加ID标识输入框 -->
                    <input type="text" class="form-input" id="custom-exchange-reason" 
                           placeholder="请输入兑换内容">
                </div>
                
                <div class="form-group">
                    <label class="form-label">消耗积分</label>
                    <!-- 添加ID标识输入框 -->
                    <input type="number" class="form-input" id="custom-exchange-points" 
                           placeholder="请输入积分值" min="10">
                </div>
                
                <!-- 添加ID标识按钮 -->
                <button class="exchange-btn" id="custom-exchange-btn">提交兑换申请</button>
            </div>
        </div>
        
        <!-- 记录页面 -->
        <!-- 在记录页面部分 -->
		<div id="records" class="content-section">
			<h2 class="section-title">积分记录</h2>
			
			<div class="record-tabs">
				<div class="record-tab active" data-record="today">今日记录</div>
				<div class="record-tab" data-record="history">历史记录</div>
			</div>
			
			<div id="today-records" class="record-content active">
				<!-- 今日记录内容不变 -->
			</div>
			
			<div id="history-records" class="record-content">
				<div class="card">
					<!-- 历史记录项将在这里动态加载 -->
				</div>
				<!-- 分页控件 -->
				<div class="pagination-container">
					<button class="pagination-btn" id="prev-page" disabled>上一页</button>
					<div class="pagination-info">第 <span id="current-page">1</span> 页</div>
					<button class="pagination-btn" id="next-page">下一页</button>
				</div>
			</div>
		</div>
		
		<!-- 新增管理页面 -->
        <div id="manage" class="content-section">
            <h2 class="section-title">积分项管理</h2>
            
            <div class="manage-tabs">
                <div class="manage-tab active" data-manage="point">加分项</div>
                <div class="manage-tab" data-manage="deduction">减分项</div>
                <div class="manage-tab" data-manage="reward">兑换项</div>
            </div>
            
			<!-- 加分项管理 -->
			<div id="manage-point" class="manage-content active">
				<button class="add-item-btn" data-type="point">
					<i class="fas fa-plus"></i> 添加加分项
				</button>
				<div class="manage-items-list" id="point-items-list">
					<!-- 加分项列表将在这里动态加载 -->
				</div>
			</div>
			
			<!-- 减分项管理 -->
			<div id="manage-deduction" class="manage-content">
				<button class="add-item-btn" data-type="deduction">
					<i class="fas fa-plus"></i> 添加减分项
				</button>
				<div class="manage-items-list" id="deduction-items-list">
					<!-- 减分项列表将在这里动态加载 -->
				</div>
			</div>
			
			<!-- 兑换项管理 -->
			<div id="manage-reward" class="manage-content">
				<button class="add-item-btn" data-type="reward">
					<i class="fas fa-plus"></i> 添加兑换项
				</button>
				<div class="manage-items-list" id="reward-items-list">
					<!-- 兑换项列表将在这里动态加载 -->
				</div>
			</div>
            
        </div>
    </div>
    
    <!-- 模态框 - 用于添加/编辑积分项 -->
	<div class="modal" id="item-modal">
		<div class="modal-content">
			<div class="modal-header">
				<h3 class="modal-title" id="modal-title">添加新项目</h3>
				<button class="close-modal">&times;</button>
			</div>
			<div class="modal-body">
				<input type="hidden" id="edit-item-id">
				<input type="hidden" id="edit-item-type">
				<div class="form-group" id="category-container">
					<label class="form-label">所属类别</label>
					<select class="form-input" id="item-category">
						<option value="1">学习习惯</option>
						<option value="2">生活习惯</option>
						<option value="3">学习成绩</option>
						<option value="4">性格养成</option>
					</select>
				</div>
				<div class="form-group">
					<label class="form-label">项目名称</label>
					<input type="text" class="form-input" id="item-name" placeholder="请输入项目名称">
				</div>
				<div class="form-group">
					<label class="form-label">项目描述</label>
					<input type="text" class="form-input" id="item-desc" placeholder="请输入项目描述">
				</div>
				<div class="form-group">
					<label class="form-label">积分值</label>
					<input type="number" class="form-input" id="item-points" placeholder="请输入积分值">
				</div>

			</div>
			<div class="modal-footer">
				<button class="modal-btn cancel-btn">取消</button>
				<button class="modal-btn save-btn">保存</button>
			</div>
		</div>
	</div>
	
	<!-- 烟花容器 -->
    <div class="fireworks-container" id="fireworksContainer"></div>
	<!-- 微信登录 -->
    <div id="auth-container" style="display:none">
	  <iframe id="auth-iframe" src="about:blank"></iframe>
	</div>
    <!-- 底部导航 -->
    <div class="bottom-nav">
        <div class="nav-btn active" data-target="home">
            <i class="fas fa-home"></i>
            <span>首页</span>
        </div>
        <div class="nav-btn" data-target="exchange">
            <i class="fas fa-gift"></i>
            <span>兑换</span>
        </div>
        <div class="nav-btn" data-target="records">
            <i class="fas fa-list"></i>
            <span>记录</span>
        </div>
		<!-- 新增管理标签 -->
		<div class="nav-btn" data-target="manage">
			<i class="fas fa-cog"></i>
			<span>管理</span>
		</div>
    </div>
    
    <script>

        
        // 加分类别切换
        document.querySelectorAll('.category-card').forEach(card => {
            card.addEventListener('click', function() {
                const category = this.getAttribute('data-category');
                const targetPage = `add-${category}`;
                
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(targetPage).classList.add('active');
            });
        });
        
        // 减分类别切换
        document.querySelectorAll('#minus .category-card').forEach(card => {
            card.addEventListener('click', function() {
                const category = this.getAttribute('data-category');
                const targetPage = `minus-${category}`;
                
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(targetPage).classList.add('active');
            });
        });
        
        // 返回按钮功能
        document.querySelectorAll('.back-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const targetId = this.getAttribute('data-back');
                
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(targetId).classList.add('active');
            });
        });
        
        // 记录标签切换
        document.querySelectorAll('.record-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const targetRecord = this.getAttribute('data-record');
                
                // 更新标签状态
                document.querySelectorAll('.record-tab').forEach(t => {
                    t.classList.remove('active');
                });
                this.classList.add('active');
                
                // 更新记录内容
                document.querySelectorAll('.record-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${targetRecord}-records`).classList.add('active');
            });
        });
        
        // 加减分按钮交互效果
        document.querySelectorAll('.action-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const card = this.closest('.card');
                card.style.backgroundColor = '#f8f9ff';
                
                setTimeout(() => {
                    card.style.backgroundColor = '';
                    
                    // 显示操作成功消息
                    const isAdd = this.classList.contains('add-btn');
                    
					if(!isAdd){
						alert(`${isAdd ? '加分' : '减分'}操作已记录！`);
					}
                    
                    // 返回主加分页面
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    document.getElementById('add').classList.add('active');
                    
                    // 更新底部导航状态
                    document.querySelectorAll('.nav-btn').forEach(btn => {
                        btn.classList.remove('active');
                        if(btn.getAttribute('data-target') === 'add') {
                            btn.classList.add('active');
                        }
                    });
                }, 500);
            });
        });
        
        // 兑换按钮交互效果
        document.querySelectorAll('.exchange-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const card = this.closest('.card');
                
                // 添加动画效果
                card.style.transform = 'scale(0.98)';
                card.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
                
                setTimeout(() => {
                    card.style.transform = '';
                    card.style.boxShadow = '';
                    
                    // 显示兑换成功消息
                    alert('兑换成功！');
                }, 300);
            });
        });
        

        // 日期时间显示和更新功能
        function updateDateTime() {
            const now = new Date();
            
            // 格式化日期
            const dateOptions = { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit',
                weekday: 'short'
            };
            const dateStr = now.toLocaleDateString('zh-CN', dateOptions);
            
            // 格式化时间
            const timeOptions = {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            const timeStr = now.toLocaleTimeString('zh-CN', timeOptions);
            
            // 更新元素
            document.getElementById('current-date').textContent = dateStr;
            document.getElementById('current-time').textContent = timeStr;
        }

        // 初始化并每秒更新一次
        updateDateTime();
        setInterval(updateDateTime, 1000);

    </script>
	<script>
    // 全局变量
    const API_BASE = '/api';
    let currentUser = null;
    let pointCategories = [];
    let deductionCategories = [];
    let rewardItems = [];
	let customItems = {
		point: [],
		deduction: [],
		reward: []
	};

    // 修改主标签页切换功能，添加记录页面的自动加载
	document.querySelectorAll('.nav-tab, .nav-btn').forEach(tab => {
		tab.addEventListener('click', function() {
			const targetId = this.getAttribute('data-target');
			
			// 更新标签状态
			document.querySelectorAll('.nav-tab, .nav-btn').forEach(t => {
				t.classList.remove('active');
			});
			this.classList.add('active');
			
			// 更新内容区域
			document.querySelectorAll('.content-section').forEach(section => {
				section.classList.remove('active');
			});
			document.getElementById(targetId).classList.add('active');
			
			// 如果是首页，更新数据
			if (targetId === 'home' && currentUser) {
				loadUserData();
			}
			// 如果是记录页面，加载今日记录
			else if (targetId === 'records' && currentUser) {
				// 确保今日记录标签激活
				const todayTab = document.querySelector('.record-tab[data-record="today"]');
				if (todayTab) {
					// 更新标签状态
					document.querySelectorAll('.record-tab').forEach(t => {
						t.classList.remove('active');
					});
					todayTab.classList.add('active');
					
					// 更新记录内容
					document.querySelectorAll('.record-content').forEach(content => {
						content.classList.remove('active');
					});
					document.getElementById('today-records').classList.add('active');
					
					// 加载今日记录
					loadRecords('today');
				}
			}
		});
	});

	// 新增函数：从URL获取用户ID
	function getUserIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const encryptedUserId = urlParams.get('a');
        if (!encryptedUserId) return null;
        try {
            // Base64解码并转换为数字
            return parseInt(atob(encryptedUserId));
        } catch (e) {
            console.error('解码用户ID失败', e);
            return null;
        }
    }
	
	// 微信OpenID存储键名
    const WECHAT_OPENID_KEY = 'wechat_openid';

    // 获取微信OpenID
    function getWechatOpenid() {
        // 1. 尝试从本地存储获取
        const storedOpenid = localStorage.getItem(WECHAT_OPENID_KEY);
        if (storedOpenid) {
            return storedOpenid;
        }

        // 2. 尝试从URL参数获取 (假设后端重定向时传递了openid参数)
        const urlParams = new URLSearchParams(window.location.search);
        const urlOpenid = urlParams.get('openid');
        if (urlOpenid) {
            // 保存到本地存储
            localStorage.setItem(WECHAT_OPENID_KEY, urlOpenid);
            return urlOpenid;
        }

        // 3. 如果都没有，返回null
        return null;
    }
	
    // 启动微信授权流程
    function startWechatAuth() {
		// 显示加载状态
		document.getElementById('account-tip').innerHTML = `
			<i class="fas fa-spinner fa-spin"></i>
			<span>正在获取微信授权...</span>`;
		
		// 使用后端API获取微信授权URL
		fetch(`${API_BASE}/auth`)
		.then(response => {
			if (!response.ok) {
				throw new Error(`HTTP ${response.status}`);
			}
			return response.json(); // 正确解析JSON响应
		})
		.then(data => {
			if(data.authUrl) {
				console.log('获取授权URL成功:', data.authUrl);
				// 存储state用于后续验证
				localStorage.setItem('wechat_auth_state', data.state);
				// 跳转到微信授权页面
				window.location.href = data.authUrl;
			} else {
				throw new Error(data.error || '获取授权URL失败');
			}
		})
		.catch(error => {
			console.error('授权请求失败', error);
			document.getElementById('account-tip').innerHTML = `
				<i class="fas fa-exclamation-circle" style="color: #e74a3b;"></i>
				<span>授权失败: ${error.message}</span>
				<button id="retry-auth" style="margin-left:10px; background: #4e73df; color: white; border: none; border-radius: 5px; padding: 2px 8px;">重试</button>
			`;
			document.getElementById('retry-auth').addEventListener('click', startWechatAuth);
		});
	}
	
	// 检查URL参数中是否有授权结果
	document.addEventListener('DOMContentLoaded', function() {
		const urlParams = new URLSearchParams(window.location.search);
		if (urlParams.has('auth_success')) {
			const userInfo = JSON.parse(decodeURIComponent(urlParams.get('user')));
			console.log('微信授权成功:', userInfo);
			// 保存用户信息到localStorage
			localStorage.setItem('wechat_user', JSON.stringify(userInfo));
			localStorage.setItem('wechat_openid', userInfo.openid);
			
			// 立即重定向到干净URL
			const cleanURL = window.location.origin + window.location.pathname;
			// 添加随机参数避免缓存问题
            const timestamp = new Date().getTime();
            window.location.replace(`${cleanURL}?t=${timestamp}`);

			
		}
		
		if (urlParams.has('error')) {
			const error = urlParams.get('error');
			const message = urlParams.get('message') || '未知错误';
			
			console.error('微信授权失败:', error, message);
			document.getElementById('account-tip').innerHTML = `
				<i class="fas fa-exclamation-circle" style="color: #e74a3b;"></i>
				<span>授权失败: ${message}</span>
				<button id="retry-auth" style="margin-left:10px; background: #4e73df; color: white; border: none; border-radius: 5px; padding: 2px 8px;">重试</button>
			`;
			document.getElementById('retry-auth').addEventListener('click', startWechatAuth);
		}
	});
	
	
	let userLoaded = false;
	// 从URL获取用户ID
	const userId = getUserIdFromUrl();
	if(!userId){
		// 在微信环境中使用
		const ua = window.navigator.userAgent.toLowerCase();
		if (ua.includes('micromessenger')) {
			const openid = getWechatOpenid();
			if (!openid) {
				// 如果没有openid，启动微信授权流程
				startWechatAuth();
			}
		}
	}
	
	
	
	// 在 initApp 函数中，添加记录页面的初始化
	async function initApp() {
		// 更新日期时间
		updateDateTime();
		setInterval(updateDateTime, 1000);
		
		// 从URL获取用户ID
		const userId = getUserIdFromUrl();
		
		// 尝试通过ID加载用户
        
        if (userId) {
            userLoaded = await loadUserById(userId);
        }

		//微信用户
		const openid = getWechatOpenid();
		if (!userLoaded&&openid) {
			// 使用openid加载用户
			userLoaded = await fetchUserByOpenid(openid);
		}
		
        // 如果加载失败，使用演示账号
        if (!userLoaded) {
            console.log('使用演示账号');
            await loadUserById(2); // 加载演示账号
        }
		
		if (currentUser) {
			updateUserInfo();
			await loadUserData();
		}
		
		// 绑定自定义兑换按钮
		const customExchangeBtn = document.getElementById('custom-exchange-btn');
		if (customExchangeBtn) {
			customExchangeBtn.addEventListener('click', customExchange);
		}
		
		// 加载静态数据
		await loadStaticData();

		// 添加账号提示逻辑
		const accountTip = document.getElementById('account-tip');
		const accountRequest = document.getElementById('account-request');
		const hideTipBtn = document.getElementById('hide-tip-btn');
		
		// 检查是否已隐藏提示
		const hideTip = localStorage.getItem('hideAccountTip');
		
		// 如果是演示用户且未隐藏提示，则显示
		if (currentUser && currentUser.id === 2 && !hideTip) {
			accountTip.style.display = 'block';
			accountRequest.style.display = 'block';
		}
		
		// 隐藏提示按钮事件
		if (hideTipBtn) {
			hideTipBtn.addEventListener('click', function() {
				accountTip.style.display = 'none';
				accountRequest.style.display = 'none';
				localStorage.setItem('hideAccountTip', 'true');
			});
		}
		
		if (currentUser) {
			// 加载自定义项
			await loadCustomItems();
		}
		
		// 设置管理功能
		setupManagement();
	}

	// 在页面加载时生成二维码
	document.addEventListener('DOMContentLoaded', function() {
		const qrcodeContainer = document.getElementById('qrcode-container');
		if (qrcodeContainer) {
			// 创建二维码 - 实际使用时应替换为真实群二维码
			const qrCodeImg = document.createElement('img');
			qrCodeImg.src = 'qun.png';
			qrCodeImg.alt = '加群二维码';
			qrCodeImg.style.width = '100%';
			qrCodeImg.style.height = '100%';
			qrCodeImg.style.borderRadius = '10px';
			qrcodeContainer.innerHTML = '';
			qrcodeContainer.appendChild(qrCodeImg);
		}
	});

    
    // 日期时间显示和更新功能
    function updateDateTime() {
        const now = new Date();
        
        // 格式化日期
        const dateOptions = { 
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit',
            weekday: 'short'
        };
        const dateStr = now.toLocaleDateString('zh-CN', dateOptions);
        
        // 格式化时间
        const timeOptions = {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        };
        const timeStr = now.toLocaleTimeString('zh-CN', timeOptions);
        
        // 更新元素
        document.getElementById('current-date').textContent = dateStr;
        document.getElementById('current-time').textContent = timeStr;
    }
    
	
	// 新增函数：通过ID加载单个用户
    async function loadUserById(userId) {
        try {
            const response = await fetch(`${API_BASE}/users/${userId}`);
            if (!response.ok) throw new Error('获取用户失败');
            
            currentUser = await response.json();
            
            // 添加默认头像URL（如果API未提供）
            if (!currentUser.avatar) {
                const nameInitial = currentUser.name.charAt(0);
                currentUser.avatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(nameInitial)}&background=4e73df&color=fff&rounded=true&size=100`;
            }
            
            // 更新用户信息显示
            updateUserInfo();
            return true;
        } catch (error) {
            console.error('加载用户数据失败:', error);
            return false;
        }
    }
	
	// 新增函数：通过openID加载单个用户
    async function fetchUserByOpenid(open_id) {
        try {
            const response = await fetch(`${API_BASE}/fetchUserByOpenid/${open_id}`);
            if (!response.ok) throw new Error('获取用户失败');
            
            currentUser = await response.json();
            // 添加默认头像URL（如果API未提供）
            if (!currentUser.avatar) {
                const nameInitial = currentUser.name.charAt(0);
                currentUser.avatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(nameInitial)}&background=4e73df&color=fff&rounded=true&size=100`;
            }
            
            // 更新用户信息显示
            updateUserInfo();
            return true;
        } catch (error) {
            console.error('加载用户数据失败:', error);
            return false;
        }
    }


    // 更新用户信息显示
    // 更新用户信息显示
	function updateUserInfo() {
		if (!currentUser) return;
		//更新成长树
		initGrowthTree();
		const nameElement = document.querySelector('.user-details h1');
		const pointsElement = document.querySelector('.points-value');
		const avatarContainer = document.querySelector('.avatar');
		const gradeElement = document.querySelector('.user-details p');
		const biaoxian = document.getElementById('biaoxian');
		
		// 更新姓名
		nameElement.textContent = currentUser.name;
		
		// 更新年级
		gradeElement.textContent = currentUser.grade;

		// 更新积分
		pointsElement.textContent = currentUser.total_points;
		
		if(currentUser.total_points>=200){
			biaoxian.innerHTML="表现优秀！";
		}else if(currentUser.total_points>100&&currentUser.total_points<200){
			biaoxian.innerHTML="表现不错！";
		}else{
			biaoxian.innerHTML="加油吧！少年";
		}
		
		
		// 更新头像
		avatarContainer.innerHTML = ''; // 清空容器
		
		if (currentUser.avatar) {
			// 如果有头像URL，显示图片
			const img = document.createElement('img');
			img.src = currentUser.avatar;
			img.alt = currentUser.name;
			img.style.width = '100%';
			img.style.height = '100%';
			img.style.borderRadius = '50%';
			img.style.objectFit = 'cover';
			avatarContainer.appendChild(img);
		} else {
			// 如果没有头像URL，显示默认图标
			const icon = document.createElement('i');
			icon.className = 'fas fa-user';
			avatarContainer.appendChild(icon);
		}
	}
    
    // 加载用户相关数据
    async function loadUserData() {
        if (!currentUser) return;
        
        try {
            // 获取用户摘要信息
            const summaryResponse = await fetch(`${API_BASE}/summary/${currentUser.id}`);
            if (!summaryResponse.ok) throw new Error('获取用户摘要失败');
            const summaryData = await summaryResponse.json();
            
            // 更新今日表现
            updateTodayPerformance(summaryData);
            
            // 获取图表数据
            const chartResponse = await fetch(`${API_BASE}/chart_data/${currentUser.id}`);
            if (!chartResponse.ok) throw new Error('获取图表数据失败');
            
            // 修复：正确处理图表数据结构
            const chartResult = await chartResponse.json();
            
            // 检查不同可能的响应格式
            let chartData = [];
            if (Array.isArray(chartResult)) {
                // 如果直接返回数组
                chartData = chartResult;
            } else if (chartResult.data && Array.isArray(chartResult.data)) {
                // 如果返回 { data: [...] }
                chartData = chartResult.data;
            } else if (chartResult.chart_data && Array.isArray(chartResult.chart_data)) {
                // 如果返回 { chart_data: [...] }
                chartData = chartResult.chart_data;
            } else {
                console.warn('无法识别的图表数据结构:', chartResult);
            }
            
            // 更新图表
            updateChart(chartData);
            
        } catch (error) {
            console.error('加载用户数据失败:', error);
        }
    }
    
    // 更新今日表现
    function updateTodayPerformance(data) {
        // 更新今日加分/减分
        document.querySelector('.add-summary .summary-value').textContent = `+${data.today_added || 0}`;
        document.querySelector('.minus-summary .summary-value').textContent = `${data.today_deducted || 0}`;
        
        // 更新最近记录时间
        const lastRecord = data.last_record ? new Date(data.last_record).toLocaleTimeString() : '无记录';
        document.querySelector('.performance-time').textContent = `最近记录时间: ${lastRecord}`;
        
        // 清空现有记录
        const todayPerformance = document.querySelector('.today-performance');
        const existingCards = todayPerformance.querySelectorAll('.card:not(.section-title)');
        existingCards.forEach(card => card.remove());
        
        // 添加今日记录卡片
        data.today_records.forEach(record => {
            const isAdd = record.points > 0;
            const card = document.createElement('div');
            card.className = 'card';
            
            card.innerHTML = `
                <div class="card-header">
                    <div class="card-title">${record.description}</div>
                    <div class="points-badge">${isAdd ? '+' : ''}${record.points}分</div>
                </div>
                <div class="card-content">
                    ${new Date(record.created_at).toLocaleTimeString()}
                </div>
            `;
            
            todayPerformance.insertBefore(card, document.querySelector('.performance-time'));
        });
    }
    
    // 更新图表函数
	function updateChart(data) {
		const chartContainer = document.querySelector('.chart');
		chartContainer.innerHTML = '';
		
		if (!Array.isArray(data) || data.length === 0) {
			chartContainer.innerHTML = '<p class="no-items">暂无图表数据</p>';
			return;
		}
		
		const maxValue = Math.max(...data.map(item => Math.max(item.added, Math.abs(item.deducted))));
		const maxHeight = 150;
		const weekdays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
		
		data.forEach(item => {
			const date = new Date(item.date);
			const dayOfWeek = weekdays[date.getDay()];
			const addedHeight = maxValue > 0 ? (item.added / maxValue) * maxHeight : 0;
			const deductedHeight = maxValue > 0 ? (Math.abs(item.deducted) / maxValue) * maxHeight : 0;
			
			const barContainer = document.createElement('div');
			barContainer.style.position = 'relative';
			barContainer.style.height = '100%';
			barContainer.style.width = '14%';
			barContainer.style.display = 'flex';
			barContainer.style.flexDirection = 'column';
			barContainer.style.justifyContent = 'flex-end';
			barContainer.style.alignItems = 'center';
			
			if (item.deducted < 0) {
				const deductedBar = document.createElement('div');
				deductedBar.className = 'chart-bar';
				deductedBar.style.background = 'linear-gradient(to top, var(--danger), #f1948a)';
				deductedBar.style.height = `${deductedHeight}px`;
				deductedBar.style.width = '80%';
				deductedBar.style.marginBottom = '5px';
				
				const deductedValue = document.createElement('div');
				deductedValue.className = 'chart-value';
				deductedValue.textContent = item.deducted;
				
				// 将减分标签放在柱子内部顶部
				deductedValue.style.position = 'absolute';
				deductedValue.style.bottom = '100%'; // 位于柱子顶部之上
				deductedValue.style.left = '0';
				deductedValue.style.right = '0';
				deductedValue.style.textAlign = 'center';
				deductedValue.style.color = 'var(--danger)';
				deductedValue.style.fontSize = '0.85rem';
				deductedValue.style.fontWeight = 'bold';
				deductedValue.style.marginBottom = '2px'; // 与柱子保持一点距离
				
				deductedBar.appendChild(deductedValue);
				barContainer.appendChild(deductedBar);
			}
			
			if (item.added > 0) {
				const addedBar = document.createElement('div');
				addedBar.className = 'chart-bar';
				addedBar.style.background = 'linear-gradient(to top, var(--secondary), #58d68d)';
				addedBar.style.height = `${addedHeight}px`;
				addedBar.style.width = '80%';
				
				const addedValue = document.createElement('div');
				addedValue.className = 'chart-value';
				addedValue.textContent = `+${item.added}`;
				
				// 将加分标签放在柱子内部顶部
				addedValue.style.position = 'absolute';
				addedValue.style.top = '0'; // 位于柱子内部顶部
				addedValue.style.left = '0';
				addedValue.style.right = '0';
				addedValue.style.textAlign = 'center';
				addedValue.style.color = 'white'; // 使用白色确保可读性
				addedValue.style.paddingTop = '5px'; // 顶部内边距
				addedValue.style.fontSize = '0.85rem';
				addedValue.style.fontWeight = 'bold';
				addedValue.style.textShadow = '0 0 2px rgba(0,0,0,0.5)'; // 文字阴影增强对比度
				
				addedBar.appendChild(addedValue);
				barContainer.appendChild(addedBar);
			}
			
			const dateLabel = document.createElement('div');
			dateLabel.className = 'chart-label';
			dateLabel.textContent = dayOfWeek;
			
			barContainer.appendChild(dateLabel);
			chartContainer.appendChild(barContainer);
		});
	}
    
    // 加载静态数据（类别和奖励项）
    // 在 index.html 的 loadStaticData 函数中
	async function loadStaticData() {
		
		try {
			// 加载加分类别和项目
			const pointResponse = await fetch(`${API_BASE}/point_categories_with_items?user_id=${currentUser.id}`);
			if (!pointResponse.ok) {
				const errorText = await pointResponse.text();
				console.error('Failed to load point categories:', pointResponse.status, errorText);
				throw new Error(`HTTP ${pointResponse.status}: ${errorText}`);
			}
			pointCategories = await pointResponse.json();
			console.log('Loaded point categories:', pointCategories);

			// 加载减分类别和项目
			const deductionResponse = await fetch(`${API_BASE}/deduction_categories_with_items?user_id=${currentUser.id}`);
			if (!deductionResponse.ok) {
				const errorText = await deductionResponse.text();
				console.error('Failed to load deduction categories:', deductionResponse.status, errorText);
				throw new Error(`HTTP ${deductionResponse.status}: ${errorText}`);
			}
			deductionCategories = await deductionResponse.json();
			console.log('Loaded deduction categories:', deductionCategories);
			
			// 加载奖励项
			const rewardResponse = await fetch(`${API_BASE}/reward_items?user_id=${currentUser.id}`);
			if (!rewardResponse.ok) throw new Error('获取奖励项失败');
			rewardItems = await rewardResponse.json();
			
			// 渲染奖励项
			renderRewardItems();
			
			// 在控制台输出分类数据
			console.log('Point Categories:', pointCategories);
			console.log('Deduction Categories:', deductionCategories);
			
		} catch (error) {
			console.error('加载静态数据失败:', error);
		}
	}
    

	// 渲染奖励项
	function renderRewardItems() {
		// 渲染首页推荐区域
		const homeExchangeContainer = document.querySelector('.cards-container.jftj');
		if (homeExchangeContainer) {
			homeExchangeContainer.innerHTML = '';
			
			if (!rewardItems || rewardItems.length === 0) {
				homeExchangeContainer.innerHTML = '<p class="no-items">暂无推荐奖励</p>';
				return;
			}
			
			// 只取前4个非自定义项作为推荐
			const recommendedItems = rewardItems.filter(item => !item.is_custom&&item.tag).slice(0, 4);
			if (recommendedItems.length === 0) {
				homeExchangeContainer.innerHTML = '<p class="no-items">暂无推荐奖励</p>';
				return;
			}
			
			recommendedItems.forEach(item => {
				const card = createRewardCard(item);
				homeExchangeContainer.appendChild(card);
			});
		}
		
		// 渲染兑换页面区域
		const exchangeContainer = document.getElementById('jfdh');
		if (exchangeContainer) {
			exchangeContainer.innerHTML = '';
			
			if (!rewardItems || rewardItems.length === 0) {
				exchangeContainer.innerHTML = '<p class="no-items">暂无奖励项目</p>';
				return;
			}
			
			// 显示所有非自定义项
			const exchangeItems = rewardItems.filter(item => !item.is_custom);
			
			if (exchangeItems.length === 0) {
				exchangeContainer.innerHTML = '<p class="no-items">暂无奖励项目</p>';
				return;
			}
			
			exchangeItems.forEach(item => {
				const card = createRewardCard(item);
				exchangeContainer.appendChild(card);
			});
		}
	}

	// 创建奖励卡片通用函数
	function createRewardCard(item) {
		const card = document.createElement('div');
		card.className = 'card exchange-card';
		
		// 添加热门标签
		if (item.tag) {
			const badge = document.createElement('div');
			badge.className = 'exchange-badge';
			badge.textContent = item.tag;
			card.appendChild(badge);
		}
		
		// 创建卡片内容容器
		const cardContent = document.createElement('div');
		cardContent.innerHTML = `
			<div class="card-title">${item.name}</div>
			<div class="exchange-points">${item.points}分</div>
			<p class="card-content">${item.description}</p>
			<button class="exchange-btn" data-id="${item.id}">立即兑换</button>
		`;
		
		card.appendChild(cardContent);
		return card;
	}
    
    // 主标签页切换功能
	document.querySelectorAll('.nav-tab, .nav-btn').forEach(tab => {
        tab.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            
            // 更新标签状态
            document.querySelectorAll('.nav-tab, .nav-btn').forEach(t => {
                t.classList.remove('active');
            });
            this.classList.add('active');
            
            // 更新内容区域
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(targetId).classList.add('active');
            
            // 添加滚动控制
			setTimeout(() => {
				if (targetId === 'home' ) {
					window.scrollTo({
						top: 0,
						behavior: 'smooth'
					});
				} else {
					// 创建或获取锚点元素
					let anchor = document.getElementById('scroll-anchor');
					if (!anchor) {
						anchor = document.createElement('div');
						anchor.id = 'scroll-anchor';
						anchor.style.position = 'absolute';
						anchor.style.top = '0';
						anchor.style.left = '0';
						anchor.style.width = '1px';
						anchor.style.height = '1px';
						anchor.style.visibility = 'hidden';
						document.body.appendChild(anchor);
					}
					
					// 将锚点放在导航栏下方
					const navTabs = document.querySelector('.nav-tabs');
					if (navTabs) {
						const navRect = navTabs.getBoundingClientRect();
						anchor.style.top = `${navRect.top + window.scrollY}px`;
						
						// 计算需要减去的高度（头部高度+5px缓冲）
						const header = document.querySelector('header');
						const headerHeight = header ? header.offsetHeight : 0;
						const offset = headerHeight + 5;
						
						// 滚动到锚点位置并减去偏移量
						window.scrollTo({
							top: anchor.offsetTop - offset,
							behavior: 'smooth'
						});
					}
				}
			}, 100);
            
            // 如果是首页，更新数据
            if (targetId === 'home' && currentUser) {
                loadUserData();
            }
            // 如果是记录页面，加载今日记录
            else if (targetId === 'records' && currentUser) {
                // ... 记录页面相关代码保持不变 ...
            }
        });
    });
    // 加分类别切换
    document.querySelectorAll('.category-card').forEach(card => {
        card.addEventListener('click', function() {
            const category = this.getAttribute('data-category');
            const targetPage = `add-${category}`;
            
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(targetPage).classList.add('active');
            
            // 如果是其他类别，跳过
            if (category === 'other') return;
            
            // 渲染具体加分项
            renderPointItems(category);
        });
    });
    
    // 渲染加分项
	function renderPointItems(category) {
		const container = document.getElementById(`add-${category}`);
		if (!container) return;
		
		// 清空现有内容（保留返回按钮和标题）
		const existingCards = container.querySelectorAll('.card.add-points');
		existingCards.forEach(card => card.remove());
		
		console.log('Point categories:', pointCategories); // 调试日志
		
		// 找到对应类别 - 使用更智能的匹配方式
		let categoryData = null;
		const categoryMappings = {
			'study': 1,
			'life': 2,
			'grade': 3,
			'character': 4
		};
		
		// 2. 尝试匹配ID
		if (!categoryData) {
			categoryData = pointCategories.find(c => 
				c.id  === categoryMappings[category]
			);
		}
		
		if (!categoryData || !categoryData.items) {
			console.warn(`No items found for point category: ${category}`, categoryData);
			container.innerHTML += '<p class="no-items">暂无加分项</p>';
			return;
		}
		
		console.log('Found category data:', categoryData); // 调试日志
		
		// 添加加分项
		categoryData.items.forEach(item => {
			const card = document.createElement('div');
			card.className = 'card add-points';
			
			card.innerHTML = `
				<div class="card-header">
					<div class="card-title">${item.name || '未命名'}</div>
					<div class="points-badge">+${item.points || 0}分</div>
				</div>
				<div class="card-content">
					${item.description || '暂无描述'}
				</div>
				<button class="action-btn add-btn" data-id="${item.id}">加分</button>
			`;
			
			container.appendChild(card);
		});
	}


   // 更新减分类别切换逻辑
	document.querySelectorAll('#minus .category-card').forEach(card => {
		card.addEventListener('click', function() {
			const category = this.getAttribute('data-category');
			const targetPage = `minus-${category}`;
			
			document.querySelectorAll('.content-section').forEach(section => {
				section.classList.remove('active');
			});
			
			// 确保目标页面存在
			if (document.getElementById(targetPage)) {
				document.getElementById(targetPage).classList.add('active');
				// 渲染具体减分项
				renderDeductionItems(category);
			} else {
				// 回退到减分主页面
				document.getElementById('minus').classList.add('active');
				console.error(`页面 ${targetPage} 未找到`);
			}
		});
	});

	// 完善减分项渲染函数
	function renderDeductionItems(category) {
		const container = document.getElementById(`minus-${category}`);
		if (!container) return;
		
		// 清空现有内容（保留返回按钮和标题）
		const existingCards = container.querySelectorAll('.card.minus-points');
		existingCards.forEach(card => card.remove());
		
		// 建立类别名称映射
		const categoryMappings = {
			'study': 6,
			'life': 7,
			'grade': 8,
			'character': 9
		};
		
		// 查找匹配的类别
		let matchedCategory = null;
		
		// 2. 尝试匹配ID
		if (!matchedCategory) {
			matchedCategory = deductionCategories.find(c => 
				c.id  === categoryMappings[category]
			);
		}

		
		if (category != 'other'&&(!matchedCategory || !matchedCategory.items || matchedCategory.items.length === 0)) {
			const noItems = document.createElement('p');
			noItems.className = 'no-items';
			noItems.textContent = '暂无减分项';
			container.appendChild(noItems);
			return;
		}
		
		// 添加减分项
		matchedCategory.items.forEach(item => {
			const card = document.createElement('div');
			card.className = 'card minus-points';
			
			card.innerHTML = `
				<div class="card-header">
					<div class="card-title">${item.name || '未命名'}</div>
					<div class="points-badge">${item.points || 0}分</div>
				</div>
				<div class="card-content">
					${item.description || '暂无描述'}
				</div>
				<button class="action-btn minus-btn" data-id="${item.id}">减分</button>
			`;
			
			container.appendChild(card);
		});
	}
    
    
    // 返回按钮功能
    document.querySelectorAll('.back-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const targetId = this.getAttribute('data-back');
            
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(targetId).classList.add('active');
        });
    });
    
    // 记录标签切换
    document.querySelectorAll('.record-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const targetRecord = this.getAttribute('data-record');
            
            // 更新标签状态
            document.querySelectorAll('.record-tab').forEach(t => {
                t.classList.remove('active');
            });
            this.classList.add('active');
            
            // 更新记录内容
            document.querySelectorAll('.record-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${targetRecord}-records`).classList.add('active');
            
            // 加载记录数据
            if (currentUser) {
                loadRecords(targetRecord);
            }
        });
    });
    
    // 加载记录数据
	async function loadRecords(type) {
		if (!currentUser) return;
		
		const container = document.getElementById(`${type}-records`);
		if (!container) return;
		
		// 显示加载状态
		container.innerHTML = `
			<div class="card">
				<div class="loading-placeholder">
					<i class="fas fa-spinner"></i>
					<div>加载记录中...</div>
				</div>
			</div>
		`;
		
		try {
			const endpoint = type === 'today' ? 
				`${API_BASE}/records/today/${currentUser.id}` :
				`${API_BASE}/records/history/${currentUser.id}`;
				
			const response = await fetch(endpoint);
			
			if (!response.ok) {
				throw new Error(`获取记录失败: ${response.status}`);
			}
			
			const data = await response.json();
			
			// 确保我们获取到的是记录数组
			let records = [];
			if (Array.isArray(data)) {
				records = data;
			} else if (data.records && Array.isArray(data.records)) {
				records = data.records;
			} else if (data.success !== false && data.records) {
				records = data.records;
			}
			
			renderRecords(records, type);
			
		} catch (error) {
			console.error('加载记录失败:', error);
			container.innerHTML = `
				<div class="card">
					<div class="error">
						<i class="fas fa-exclamation-triangle"></i>
						<div>加载记录失败: ${error.message}</div>
					</div>
				</div>
			`;
		}
	}
	// 渲染记录
	function renderRecords(records, type) {
		const container = document.getElementById(`${type}-records`);
		if (!container) return;
		
		// 清空现有记录
		container.innerHTML = '';
		
		// 创建卡片容器
		const card = document.createElement('div');
		card.className = 'card';
		container.appendChild(card);
		
		// 检查是否为空记录
		if (!Array.isArray(records) || records.length === 0) {
			const noItems = document.createElement('div');
			noItems.className = 'no-items';
			noItems.textContent = '暂无记录';
			card.appendChild(noItems);
			return;
		}
		
		// 添加记录
		records.forEach(record => {
			// 确保记录对象有效
			if (!record || typeof record !== 'object') return;
			
			const points = record.points || 0;
			const description = record.description || '未命名记录';
			const createdAt = record.time || new Date().toISOString();

			const isAdd = points > 0;
			const isExchange = record.type === 3;
			
			const item = document.createElement('div');
			item.className = `record-item ${
				isExchange ? 'exchange-record' : 
				isAdd ? 'add-points-record' : 'minus-points-record'
			}`;
			
			// 安全处理日期
			let dateStr = '未知时间';
			try {
				const date = createdAt;
				dateStr = type === 'today' ? 
					`今天 ${date}` :
					record.date;
			} catch (e) {
				console.error('日期解析错误:', e);
			}
			
			item.innerHTML = `
				<div class="record-details">
					<div class="record-title">${description}</div>
					<div class="record-date">${dateStr}</div>
				</div>
				<div class="record-points">${points}</div>
			`;
			
			card.appendChild(item);
		});
	}
    
    // 加减分按钮交互效果
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('add-btn')) {
            const itemId = e.target.getAttribute('data-id');
            if (!itemId || !currentUser) return;
            
            addPoints(itemId);
        }
        
        if (e.target.classList.contains('minus-btn')) {
            const itemId = e.target.getAttribute('data-id');
            if (!itemId || !currentUser) return;
            
            deductPoints(itemId);
        }
        
        if (e.target.classList.contains('exchange-btn')) {
            const itemId = e.target.getAttribute('data-id');
            if (!itemId || !currentUser) return;
            
            exchangeReward(itemId);
        }
    });
    
    // 加分操作
    async function addPoints(itemId) {
        try {
            const response = await fetch(`${API_BASE}/add_points`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    user_id: currentUser.id,
                    item_id: itemId
                })
            });
            
            const result = await response.json();
            if (response.ok) {
                //播放烟花音效
				showNumberFirework(result.points);
                // 更新用户积分
                currentUser.total_points = result.new_points;
                updateUserInfo();
                
                // 返回加分页面
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById('add').classList.add('active');
                
                // 更新底部导航
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-target') === 'add') {
                        btn.classList.add('active');
                    }
                });
            } else {
                alert(result.error);
            }
        } catch (error) {
            console.error('加分操作失败:', error);
            alert('加分操作失败，请稍后重试');
        }
    }
    
    // 减分操作
    async function deductPoints(itemId) {
        try {
            const response = await fetch(`${API_BASE}/deduct_points`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    user_id: currentUser.id,
                    item_id: itemId
                })
            });
            
            const result = await response.json();
            if (response.ok) {
                alert(result.message);
                
                // 更新用户积分
                currentUser.total_points = result.new_points;
                updateUserInfo();
                
                // 返回减分页面
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById('minus').classList.add('active');
                
                // 更新底部导航
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-target') === 'minus') {
                        btn.classList.add('active');
                    }
                });
            } else {
                alert(result.error);
            }
        } catch (error) {
            console.error('减分操作失败:', error);
            alert('减分操作失败，请稍后重试');
        }
    }
    
    // 兑换操作
    // 修改兑换操作 - 添加自定义兑换处理
        async function exchangeReward(itemId) {
            try {
                const response = await fetch(`${API_BASE}/exchange_reward`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        item_id: itemId
                    })
                });
                
                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    
                    // 更新用户积分
                    currentUser.total_points = result.new_points;
                    updateUserInfo();
                    
                    // 返回兑换页面
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    document.getElementById('exchange').classList.add('active');
                } else {
                    alert(result.error);
                }
            } catch (error) {
                console.error('兑换操作失败:', error);
                alert('兑换操作失败，请稍后重试');
            }
        }
        
        // 新增：自定义兑换操作
        async function customExchange() {
            // 使用ID获取元素
            const reasonInput = document.getElementById('custom-exchange-reason');
            const pointsInput = document.getElementById('custom-exchange-points');
            
            const reason = reasonInput.value;
            const points = pointsInput.value;
            
            if (!reason || !points) {
                alert('请填写兑换内容和所需积分');
                return;
            }
            
            const pointsNum = parseInt(points, 10);
            if (isNaN(pointsNum)) {
                alert('积分必须是有效的数字');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/exchange_reward`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        custom_name: reason,
                        custom_points: pointsNum
                    })
                });
                
                const result = await response.json();
                if (response.ok) {
                    
                    // 更新用户积分
                    currentUser.total_points = result.new_points;
                    updateUserInfo();
                    
                    // 清空表单
                    reasonInput.value = '';
                    pointsInput.value = '';
                } else {
                    alert(result.error);
                }
            } catch (error) {
                console.error('自定义兑换失败:', error);
                alert('自定义兑换失败，请稍后重试');
            }
        }
    
    // 自定义加分
	// 修改自定义加分函数
	document.querySelector('#add-other .add-btn').addEventListener('click', async function() {
		// 使用更可靠的 DOM 选择器
		const reasonInput = document.querySelector('#add-other .form-input[type="text"]');
		const pointsInput = document.querySelector('#add-other .form-input[type="number"]');
		
		// 确保元素存在
		if (!reasonInput || !pointsInput) {
			alert('无法找到输入框，请刷新页面重试');
			return;
		}
		
		const reason = reasonInput.value;
		const points = pointsInput.value;
		
		if (!reason || !points) {
			alert('请填写加分原因和分值');
			return;
		}
					
		try {
			const response = await fetch(`${API_BASE}/add_points`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					id: Math.floor(Math.random() * 1000000),
					user_id: currentUser.id,
					custom_name: reason,
					custom_points: parseInt(points),
					description: reason
				})
			});

			if (!response.ok) {
				const errorData = await response.json();
				throw new Error(errorData.error || '加分失败');
			}
			
			const result = await response.json();
			//播放烟花音效
			showNumberFirework(result.points);
			// 更新用户积分
			currentUser.total_points = result.new_points;
			updateUserInfo();
		
			// 清空表单
			reasonInput.value = '';
			pointsInput.value = '';
		
			// 返回加分页面
			document.querySelectorAll('.content-section').forEach(section => {
				section.classList.remove('active');
			});
			document.getElementById('add').classList.add('active');

			// 更新底部导航
			document.querySelectorAll('.nav-btn').forEach(btn => {
				btn.classList.remove('active');
				if (btn.getAttribute('data-target') === 'add') {
					btn.classList.add('active');
				}
			});
		} catch (error) {
			console.error('自定义加分失败:', error);
			alert(`自定义加分失败: ${error.message}`);
		}

	});
    
	// 自定义减分
	document.querySelector('#minus-other .minus-btn').addEventListener('click', async function() {
		// 使用更可靠的 DOM 选择器
		const reasonInput = document.querySelector('#minus-other .form-input[type="text"]');
		const pointsInput = document.querySelector('#minus-other .form-input[type="number"]');
		
		// 确保元素存在
		if (!reasonInput || !pointsInput) {
			alert('无法找到输入框，请刷新页面重试');
			return;
		}
		
		const reason = reasonInput.value;
		const points = pointsInput.value;
		
		if (!reason || !points) {
			alert('请填写加分原因和分值');
			return;
		}
		
		try {
			const response = await fetch(`${API_BASE}/deduct_points`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					id: Math.floor(Math.random() * 1000000),
					user_id: currentUser.id,
					custom_name: reason,
					custom_points: parseInt(points),
					description: reason
				})
			});
			
			if (!response.ok) {
				const errorData = await response.json();
				throw new Error(errorData.error || '减分失败');
			}
			
			const result = await response.json();
			
			// 更新用户积分
			currentUser.total_points = result.new_points;
			updateUserInfo();
			
			// 清空表单
			reasonInput.value = '';
			pointsInput.value = '';
			
			// 返回加分页面
			document.querySelectorAll('.content-section').forEach(section => {
				section.classList.remove('active');
			});
			document.getElementById('minus').classList.add('active');
			
			// 更新底部导航
			document.querySelectorAll('.nav-btn').forEach(btn => {
				btn.classList.remove('active');
				if (btn.getAttribute('data-target') === 'minus') {
					btn.classList.add('active');
				}
			});
		} catch (error) {
			console.error('自定义加分失败:', error);
			alert(`自定义加分失败: ${error.message}`);
		}
	});
   
    
	// 从API加载自定义项
	async function loadCustomItems() {
		if (!currentUser) return;
		
		try {
			// 加分项
			const pointResponse = await fetch(`/api/custom_items?user_id=${currentUser.id}&item_type=0`);
			if (pointResponse.ok) {
				customItems.point = await pointResponse.json();
			}
			
			// 减分项
			const deductionResponse = await fetch(`/api/custom_items?user_id=${currentUser.id}&item_type=1`);
			if (deductionResponse.ok) {
				customItems.deduction = await deductionResponse.json();
			}
			
			// 兑换项
			const rewardResponse = await fetch(`/api/user_reward_items?user_id=${currentUser.id}`);
			if (rewardResponse.ok) {
				customItems.reward = await rewardResponse.json();
			}
			
			// 渲染自定义项
			renderCustomItems('point');
			renderCustomItems('deduction');
			renderCustomItems('reward');
			
		} catch (error) {
			console.error('加载自定义项失败:', error);
		}
	}

	// 渲染自定义项
	function renderCustomItems(type) {
		const container = document.getElementById(`${type}-items-list`);
		if (!container) return;
		
		container.innerHTML = '';
		
		// 获取当前用户的自定义项
		const items = customItems[type];
		
		if (!items || items.length === 0) {
			container.innerHTML = '<div class="no-items">暂无项目</div>';
			return;
		}
		
		items.forEach(item => {
			const itemElement = document.createElement('div');
			itemElement.className = 'manage-item';
			var lb;
			if(item.category_id=='1'||item.category_id=='6'){
				lb="学习习惯";
			}
			if(item.category_id=='2'||item.category_id=='7'){
				lb="生活习惯";
			}
			if(item.category_id=='3'||item.category_id=='8'){
				lb="学习成绩";
			}
			if(item.category_id=='4'||item.category_id=='10'){
				lb="性格养成";
			}
			var lbHtml = ``;
			if (type !== 'reward') {
				lbHtml = `<span style="color:#3b7bbd">[${lb}]</span>`;
			}
			itemElement.innerHTML = `
				<div class="manage-item-details">
					<div class="manage-item-name">${lbHtml}${item.name}</div>
					<div class="manage-item-desc">${item.description || '无描述'}</div>
					<div class="manage-item-points">积分值: ${item.points}</div>
				</div>
				<div class="manage-item-actions">
					<button class="edit-btn" data-type="${type}" data-id="${item.id}">
						<i class="fas fa-edit"></i>
					</button>
					<button class="delete-btn" data-type="${type}" data-id="${item.id}">
						<i class="fas fa-trash"></i>
					</button>
				</div>
			`;
			
			container.appendChild(itemElement);
		});
		
		// 添加编辑和删除事件
		container.querySelectorAll('.edit-btn').forEach(btn => {
			btn.addEventListener('click', function() {
				const itemId = this.getAttribute('data-id');
				const itemType = this.getAttribute('data-type');
				openItemModal(itemType, itemId);
			});
		});
		
		container.querySelectorAll('.delete-btn').forEach(btn => {
			btn.addEventListener('click', function() {
				const itemId = this.getAttribute('data-id');
				const itemType = this.getAttribute('data-type');
				deleteCustomItem(itemType, itemId);
			});
		});
	}

	// 打开项目模态框
	function openItemModal(type, itemId = null) {
		const modal = document.getElementById('item-modal');
		const title = document.getElementById('modal-title');
		const idInput = document.getElementById('edit-item-id');
		const typeInput = document.getElementById('edit-item-type');
		const nameInput = document.getElementById('item-name');
		const descInput = document.getElementById('item-desc');
		const pointsInput = document.getElementById('item-points');
		const categorySelect = document.getElementById('item-category');
		const categoryContainer = document.getElementById('category-container');
		
		// 设置标题
		const typeName = type === 'point' ? '加分' : type === 'deduction' ? '减分' : '兑换';
		title.textContent = itemId ? `编辑${typeName}项` : `添加${typeName}项`;
		
		// 设置类型和ID
		typeInput.value = type;
		idInput.value = itemId || '';
		
		// 如果是兑换项，隐藏类别选择
		if (type === 'reward') {
			categoryContainer.style.display = 'none';
		} else {
			categoryContainer.style.display = 'block';
		}
		
		// 如果是编辑模式，填充数据
		if (itemId) {
			const items = customItems[type];
			const item = items.find(i => i.id == itemId);
			if (item) {
				nameInput.value = item.name;
				descInput.value = item.description || '';
				pointsInput.value = item.points;
				
				if (item.category) {
					if(type === 'deduction'){
						if(item.category==6){
							item.category=1;
						}
						if(item.category==7){
							item.category=2;
						}
						if(item.category==8){
							item.category=3;
						}
						if(item.category==9){
							item.category=4;
						}
					}
					alert(item.category)
					categorySelect.value = item.category;
				}
			}
		} else {
			// 清空表单
			nameInput.value = '';
			descInput.value = '';
			pointsInput.value = '';
			categorySelect.value = '1';
		}
		
		// 显示模态框
		modal.style.display = 'flex';
	}

	// 保存自定义项
	async function saveCustomItem() {
		const modal = document.getElementById('item-modal');
		const type = document.getElementById('edit-item-type').value;
		const itemId = document.getElementById('edit-item-id').value;
		const name = document.getElementById('item-name').value.trim();
		const desc = document.getElementById('item-desc').value.trim();
		var points = parseInt(document.getElementById('item-points').value);
		var category = document.getElementById('item-category').value;
		
		// 验证输入
		if (!name) {
			alert('请填写项目名称');
			return;
		}
		
		if (isNaN(points)) {
			alert('请填写有效的积分值');
			return;
		}
		
		if(type === 'deduction'){
			if(category==1){
				category=6;
			}
			if(category==2){
				category=7;
			}
			if(category==3){
				category=8;
			}
			if(category==4){
				category=9;
			}
			if(points>0){
				points= -points;
			}
			
		}

		const itemData = {
			user_id: currentUser.id,
			name: name,
			description: desc,
			points: points
		};
		
		if (type !== 'reward') {
			itemData.category_id = category;
		}
		
		try {
			var url = itemId ? `/api/custom_items` : '/api/custom_items';
			if (type == 'reward') {
				url = '/api/custom_reward_items';
			}
			const method = itemId ? 'POST' : 'POST';
			if (itemId) {
				itemData.id = itemId;
			}
		
			const response = await fetch(url, {
				method: method,
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(itemData)
			});
			
			if (response.ok) {
				const result = await response.json();
				
				// 更新本地数据
				await loadCustomItems();
				
				// 关闭模态框
				closeModal();
				
				// 显示成功消息
				alert(`项目已${itemId ? '更新' : '添加'}成功！`);
				initApp();
			} else {
				const error = await response.json();
				alert(`保存失败: ${error.error}`);
			}
		} catch (error) {
			console.error('保存项目失败:', error);
			alert('保存项目失败，请稍后重试');
		}
	}

	// 删除自定义项
	async function deleteCustomItem(type, itemId) {
		if (!confirm('确定要删除这个项目吗？')) return;
		
		try {
			const url = type !== 'reward' ? `/api/custom_items/${itemId}?user_id=${currentUser.id}` : `/api/custom_reward_items/${itemId}?user_id=${currentUser.id}` ;
			const response = await fetch(url, {
				method: 'DELETE'
			});
			
			if (response.ok) {
				// 从本地数据中移除
				customItems[type] = customItems[type].filter(item => item.id != itemId);
				
				// 重新渲染列表
				renderCustomItems(type);
				
				alert('项目已删除！');
				initApp();
			} else {
				const error = await response.json();
				alert(`删除失败: ${error.error}`);
			}
		} catch (error) {
			console.error('删除项目失败:', error);
			alert('删除项目失败，请稍后重试');
		}
	}

	// 初始化管理功能
	function setupManagement() {
		// 管理标签切换
		document.querySelectorAll('.manage-tab').forEach(tab => {
			tab.addEventListener('click', function() {
				const target = this.getAttribute('data-manage');
				
				// 更新标签状态
				document.querySelectorAll('.manage-tab').forEach(t => {
					t.classList.remove('active');
				});
				this.classList.add('active');
				
				// 显示目标管理内容
				document.querySelectorAll('.manage-content').forEach(content => {
					content.classList.remove('active');
				});
				document.getElementById(`manage-${target}`).classList.add('active');
			});
		});
		
		// 添加项目按钮
		document.querySelectorAll('.add-item-btn').forEach(btn => {
			btn.addEventListener('click', function() {
				const type = this.getAttribute('data-type');
				openItemModal(type);
			});
		});
		
		
		// 模态框控制
		document.querySelector('.close-modal').addEventListener('click', closeModal);
		document.querySelector('.cancel-btn').addEventListener('click', closeModal);
		document.querySelector('.save-btn').addEventListener('click', saveCustomItem);
	}

	// 关闭模态框
	function closeModal() {
		document.getElementById('item-modal').style.display = 'none';
	}
    
    
</script>
<script>
         // 模拟成长树动画
        const treeImage = document.querySelector('.tree-image');
        
        
        // 初始化点状动画
        createDotAnimation();
        createLeafAnimation();
        // 添加树叶飘落效果
        function createLeafAnimation() {
            const treeContainer = document.querySelector('.tree');
            if (!treeContainer) return;
            
            for (let i = 0; i < 8; i++) {
                const leaf = document.createElement('div');
                leaf.className = 'leaf';
                leaf.innerHTML = '❀';
                leaf.style.position = 'absolute';
                leaf.style.fontSize = '16px';
                leaf.style.color = '#57A773';
                leaf.style.opacity = '0.7';
                leaf.style.left = `${Math.random() * 100}%`;
                leaf.style.top = `${Math.random() * 100}%`;
                leaf.style.animation = `floatLeaf ${10 + Math.random() * 10}s linear infinite`;
                leaf.style.animationDelay = `${Math.random() * 5}s`;
                treeContainer.appendChild(leaf);
            }
        }
        
        // 添加树叶飘落动画
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes floatLeaf {
                0% {
                    transform: translate(0, 0) rotate(0deg);
                    opacity: 0.7;
                }
                50% {
                    opacity: 1;
                }
                100% {
                    transform: translate(${Math.random() > 0.5 ? '-' : ''}${20 + Math.random() * 30}px, 100px) rotate(${360 + Math.random() * 360}deg);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

		// 成长树阶段定义
        const growthStages = [
            { min: 0, max: 100, name: "嫩芽", image: "images/1.png", next: "小树苗" },
            { min: 100, max: 200, name: "小树苗", image: "images/2.png", next: "小树" },
            { min: 200, max: 400, name: "小树", image: "images/3.png", next: "中树" },
            { min: 400, max: 600, name: "中树", image: "images/4.png", next: "大树" },
            { min: 600, max: 800, name: "大树", image: "images/5.png", next: "参天大树" },
            { min: 800, max: 1000, name: "参天大树", image: "images/6.png", next: "森林之王" },
            { min: 1000, max: 9999, name: "森林之王", image: "images/7.png", next: "MAX" }
        ];
        
        // 初始化成长树
        function initGrowthTree() {
            // 从用户数据获取当前积分
            const currentPoints = currentUser ? currentUser.total_points : 0;
            updateGrowthTree(currentPoints);
        }

		// 更新成长树
        function updateGrowthTree(points) {
			const treeImage = document.getElementById('tree-image');
			const treeStage = document.getElementById('tree-stage');
			const energyValue = document.getElementById('energy-value');
			const nextStage = document.getElementById('next-stage');
			const progressFill = document.querySelector('.energy-progress');
			
			// 找到当前阶段
			const currentStage = growthStages.find(stage => points >= stage.min && points <= stage.max);
			
			if (currentStage) {
				// 更新树图片
				treeImage.src = currentStage.image;
				
				// 更新阶段名称
				treeStage.textContent = currentStage.name;
				
				// 更新能量值显示
				energyValue.textContent = `${points}/${currentStage.max}`;
				
				// 更新进度条 - 这是修复的关键部分
				const progress = Math.min(100, Math.max(0, 
					((points - currentStage.min) / (currentStage.max - currentStage.min)) * 100
				));
				
				progressFill.style.width = `${progress}%`;
				
				// 更新下一阶段提示
				if (currentStage.next === "MAX") {
					nextStage.textContent = "即将达到最高阶段！";
				} else {
					if (points >= currentStage.max) {
						// 找到下一阶段
						const nextStageIndex = growthStages.findIndex(stage => stage.name === currentStage.next);
						if (nextStageIndex !== -1) {
							const nextStageObj = growthStages[nextStageIndex];
							nextStage.textContent = `即将进入下一阶段: ${nextStageObj.name}`;
						} else {
							nextStage.textContent = `准备进入下一阶段: ${currentStage.next}`;
						}
					} else {
						const pointsNeeded = currentStage.max - points;
						nextStage.textContent = `下一阶段: ${currentStage.next} (还需${pointsNeeded}分)`;
					}
				}
			}
		}

		// 修改点状动画创建函数
		function createDotAnimation() {
			const container = document.querySelector('.dot-animation');
			if (!container) return;
			
			// 清除现有内容
			container.innerHTML = '';
			
			// 创建点 - 数量减少以提高性能
			for (let i = 0; i < 8; i++) {
				const dot = document.createElement('div');
				dot.className = 'dot';
				dot.style.left = `${Math.random() * 100}%`;
				dot.style.animationDelay = `${Math.random() * 2}s`;
				container.appendChild(dot);
			}
		}
        
        
		function showNumberFirework(number, soundEnabled = true) {
			// 确保滚动到绝对顶部
			window.scrollTo(0, 0);
			document.documentElement.scrollTop = 0;
			document.body.scrollTop = 0;
			
			const container = document.getElementById('fireworksContainer');
			container.innerHTML = '';
			
			const numberElement = document.createElement('div');
			numberElement.className = 'firework-number';
			numberElement.textContent = `+${number}`;
			container.appendChild(numberElement);
			
			if (soundEnabled) playFireworkSound();
			
			createParticles(container);
			
			setTimeout(() => numberElement.remove(), 11200);
		}
        // 创建烟花粒子
        function createParticles(container) {
            const particleCount = 120;
            const colors = ['#00c853', '#64dd17', '#a7ffeb', '#f4ff81', '#76ff03'];
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                // 随机颜色
                const color = colors[Math.floor(Math.random() * colors.length)];
                particle.style.backgroundColor = color;
                
                // 随机大小
                const size = 3 + Math.random() * 7;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                
                // 随机位置（在屏幕中心附近）
                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight / 2;
                const startX = centerX + (Math.random() - 0.5) * 50;
                const startY = centerY + (Math.random() - 0.5) * 50;
                
                particle.style.left = `${startX}px`;
                particle.style.top = `${startY}px`;
                
                // 随机运动方向
                const angle = Math.random() * Math.PI * 2;
                const distance = 100 + Math.random() * 300;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;
                
                particle.style.setProperty('--tx', `${tx}px`);
                particle.style.setProperty('--ty', `${ty}px`);
                
                // 随机动画延迟和时长
                const delay = Math.random() * 0.3;
                const duration = 0.7 + Math.random() * 0.5;
                
                particle.style.animationDelay = `${delay}s`;
                particle.style.animationDuration = `${duration}s`;
                
                container.appendChild(particle);
                
                // 动画结束后移除粒子
                setTimeout(() => {
                    particle.remove();
                }, (delay + duration) * 1000);
            }
        }
        
        // 播放烟花音效
        function playFireworkSound() {
            try {
                // 创建音频上下文
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // 创建主增益节点控制音量
                const masterGain = audioContext.createGain();
                masterGain.gain.value = 0.3;
                masterGain.connect(audioContext.destination);
                
                // 创建多个爆炸音效
                for (let i = 0; i < 3; i++) {
                    // 延迟每个爆炸音效
                    setTimeout(() => {
                        // 创建振荡器作为音源
                        const oscillator = audioContext.createOscillator();
                        
                        // 设置爆炸音效类型
                        oscillator.type = 'sine';
                        
                        // 使用更高的频率创建欢快音效
                        const baseFrequency = 600 + Math.random() * 600;
                        oscillator.frequency.setValueAtTime(baseFrequency, audioContext.currentTime);
                        
                        // 快速频率衰减
                        oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.4);
                        
                        // 创建增益节点控制音量包络
                        const gainNode = audioContext.createGain();
                        gainNode.gain.setValueAtTime(0.6, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                        
                        // 连接节点
                        oscillator.connect(gainNode);
                        gainNode.connect(masterGain);
                        
                        // 播放并停止
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.4);
                    }, i * 80); // 每个爆炸间隔80ms
                }
            } catch (e) {
                console.log("音频播放失败:", e);
            }
        }
		
		// 初始化应用
		initApp();
 
</script>
</body>
</html>